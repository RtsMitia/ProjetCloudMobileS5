var ce=Object.defineProperty;var ue=(a,e,n)=>e in a?ce(a,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[e]=n;var J=(a,e,n)=>ue(a,typeof e!="symbol"?e+"":e,n);import{x as Q,y as de,T as me,z as ge,A as O,B as F,C as P,D as he,E as R,F as W,G as fe,H as Y,r as p,p as pe,d as x,c as M,o as f,b as t,I as we,w as i,a as o,J as ve,K as X,n as z,L as C,f as ye,g as _,e as Z,k as V,i as b,j as K,M as U,N as $,O as be,P as Se,q as ke,t as Me,Q as xe,R as Le,S as D,U as _e,V as Ce,h as Ie,v as Ae}from"./index-rxUI5P4t.js";import{u as ee,_ as I,a as Te}from"./_plugin-vue_export-helper-BhuEzHeC.js";class Ee{constructor(){J(this,"collectionName","signalementListe")}async createSignalement(e){try{const n=Q.currentUser;if(!n)throw new Error("Utilisateur non connectÃ©");const s={id:null,userId:e.userId,userEmail:n.email||"",x:e.x,y:e.y,localisation:e.localisation||"",description:e.description||"",statusLibelle:e.statusLibelle||"En attente",createdAt:typeof e.createdAt=="string"?e.createdAt:me.fromDate(e.createdAt),updatedAt:de(),photoUrls:[],priority:3},l=await ge(O(F,this.collectionName),s);return console.log("Signalement crÃ©Ã© avec ID:",l.id),l.id}catch(n){throw console.error("Erreur lors de la crÃ©ation du signalement:",n),n}}async getUserSignalements(){try{const e=Q.currentUser;if(!e)throw new Error("Utilisateur non connectÃ©");const n=P(O(F,this.collectionName),he("userId","==",e.uid),R("createdAt","desc")),s=await W(n),l=[];return s.forEach(u=>{l.push({id:u.id,...u.data()})}),l}catch(e){throw console.error("Erreur lors de la rÃ©cupÃ©ration des signalements:",e),e}}async getAllSignalements(){try{const e=P(O(F,this.collectionName),R("createdAt","desc")),n=await W(e),s=[];return n.forEach(l=>{s.push({id:l.id,...l.data()})}),s}catch(e){throw console.error("Erreur lors de la rÃ©cupÃ©ration des signalements:",e),e}}subscribeToSignalements(e){const n=P(O(F,this.collectionName),R("createdAt","desc"));return fe(n,l=>{const u=[];l.forEach(c=>{u.push({id:c.id,...c.data()})}),console.log("".concat(u.length," signalements reÃ§us de Firestore")),e(u)},l=>{console.error("Erreur lors de l'Ã©coute des signalements:",l)})}}const G=new Ee;function Be(){const{currentUser:a}=ee(),e=p([]),n=p([]),s=p(!1),l=p(""),u=p("all"),c=p(!1);let S=null;function q(){S=G.subscribeToSignalements(r=>{e.value=r,L()})}function A(){S&&(S(),S=null)}function L(){var k;let r=[...e.value];u.value!=="all"&&(r=r.filter(w=>w.statusLibelle===u.value)),c.value&&((k=a.value)!=null&&k.uid)&&(r=r.filter(w=>{var v;return w.userId===((v=a.value)==null?void 0:v.uid)})),n.value=r}async function N(r,k,w,v){if(!a.value)throw new Error("Utilisateur non connectÃ©");s.value=!0,l.value="";try{const y={id:null,userId:a.value.uid,x:k,y:r,localisation:v,description:w,statusLibelle:"En attente",createdAt:new Date().toISOString()},B=await G.createSignalement(y);return console.log("âœ… Signalement crÃ©Ã©:",B),B}catch(y){throw l.value="Impossible de crÃ©er le signalement",console.error("âŒ Erreur:",y),y}finally{s.value=!1}}async function T(){s.value=!0;try{return await G.getUserSignalements()}catch(r){throw l.value="Impossible de rÃ©cupÃ©rer vos signalements",r}finally{s.value=!1}}const E=pe(()=>({total:e.value.length,filtered:n.value.length,byStatus:{enAttente:e.value.filter(r=>r.statusLibelle==="En attente").length,valide:e.value.filter(r=>r.statusLibelle==="ValidÃ©").length,enCours:e.value.filter(r=>r.statusLibelle==="En cours").length,resolu:e.value.filter(r=>r.statusLibelle==="RÃ©solu").length,rejete:e.value.filter(r=>r.statusLibelle==="RejetÃ©").length}}));return Y(()=>{A()}),{signalements:e,filteredSignalements:n,isLoading:s,error:l,stats:E,selectedStatus:u,showOnlyMySignalements:c,subscribeToSignalements:q,unsubscribeFromSignalements:A,applyFilters:L,createSignalement:N,fetchUserSignalements:T}}const Oe="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path stroke-linecap='round' stroke-linejoin='round' d='M256 112v288M400 256H112' class='ionicon-fill-none ionicon-stroke-width'/></svg>",Fe="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path stroke-linecap='round' stroke-linejoin='round' d='M32 144h448M112 256h288M208 368h96' class='ionicon-fill-none ionicon-stroke-width'/></svg>",Ue="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M192 176v-40a40 40 0 0140-40h160a40 40 0 0140 40v240a40 40 0 01-40 40H240c-22.09 0-48-17.91-48-40v-40' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/><path stroke-linecap='round' stroke-linejoin='round' d='M288 336l80-80-80-80M80 256h272' class='ionicon-fill-none ionicon-stroke-width'/></svg>",$e="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M304 336v40a40 40 0 01-40 40H104a40 40 0 01-40-40V136a40 40 0 0140-40h152c22.09 0 48 17.91 48 40v40M368 336l80-80-80-80M176 256h256' stroke-linecap='round' stroke-linejoin='round' class='ionicon-fill-none ionicon-stroke-width'/></svg>",De="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M258.9 48C141.92 46.42 46.42 141.92 48 258.9c1.56 112.19 92.91 203.54 205.1 205.1 117 1.6 212.48-93.9 210.88-210.88C462.44 140.91 371.09 49.56 258.9 48zM351 175.24l-82.24 186.52c-4.79 10.47-20.78 7-20.78-4.56V268a4 4 0 00-4-4H154.8c-11.52 0-15-15.87-4.57-20.67L336.76 161A10.73 10.73 0 01351 175.24z'/></svg>",ze="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M336.76 161l-186.53 82.35c-10.47 4.8-6.95 20.67 4.57 20.67H244a4 4 0 014 4v89.18c0 11.52 16 15 20.78 4.56L351 175.24A10.73 10.73 0 00336.76 161z'/><path d='M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z' stroke-miterlimit='10' class='ionicon-fill-none ionicon-stroke-width'/></svg>",Ve=x({__name:"MapHeader",props:{isAuthenticated:{type:Boolean}},emits:["toggleFilters","logout","goToLogin"],setup(a){return(e,n)=>(f(),M(t(we),{class:"modern-header"},{default:i(()=>[o(t(Z),{class:"modern-toolbar"},{default:i(()=>[o(t(X),{slot:"start"},{default:i(()=>[o(t(z),{onClick:n[0]||(n[0]=s=>e.$emit("toggleFilters")),class:"modern-icon-button"},{default:i(()=>[o(t(C),{icon:t(Fe)},null,8,["icon"])]),_:1})]),_:1}),o(t(ye),{class:"modern-title"},{default:i(()=>[...n[3]||(n[3]=[_("Carte des Signalements",-1)])]),_:1}),o(t(X),{slot:"end"},{default:i(()=>[a.isAuthenticated?(f(),M(t(z),{key:0,onClick:n[1]||(n[1]=s=>e.$emit("logout")),class:"modern-icon-button"},{default:i(()=>[o(t(C),{icon:t($e)},null,8,["icon"])]),_:1})):(f(),M(t(z),{key:1,onClick:n[2]||(n[2]=s=>e.$emit("goToLogin")),class:"modern-icon-button"},{default:i(()=>[o(t(C),{icon:t(Ue)},null,8,["icon"])]),_:1}))]),_:1})]),_:1}),ve(e.$slots,"filters",{},void 0,!0)]),_:3}))}}),qe=I(Ve,[["__scopeId","data-v-fbd618ef"]]),Ne={class:"filters-container"},He={class:"filter-section"},je={key:0,class:"filter-section"},Pe={class:"checkbox-container"},Re=x({__name:"MapFilters",props:{show:{type:Boolean},modelStatus:{},modelOnlyMine:{type:Boolean},isAuthenticated:{type:Boolean}},emits:["update:modelStatus","update:modelOnlyMine","filtersChanged"],setup(a,{emit:e}){const n=e;function s(u){n("update:modelStatus",u.detail.value),n("filtersChanged")}function l(u){n("update:modelOnlyMine",u.detail.checked),n("filtersChanged")}return(u,c)=>a.show?(f(),M(t(Z),{key:0,class:"filters-toolbar"},{default:i(()=>[b("div",Ne,[b("div",He,[c[4]||(c[4]=b("label",{class:"filter-label"},"Statut",-1)),o(t(be),{value:a.modelStatus,onIonChange:s,class:"modern-segment"},{default:i(()=>[o(t(U),{value:"all",class:"modern-segment-button"},{default:i(()=>[o(t($),null,{default:i(()=>[...c[0]||(c[0]=[_("Tous",-1)])]),_:1})]),_:1}),o(t(U),{value:"En attente",class:"modern-segment-button"},{default:i(()=>[o(t($),null,{default:i(()=>[...c[1]||(c[1]=[_("En attente",-1)])]),_:1})]),_:1}),o(t(U),{value:"En cours",class:"modern-segment-button"},{default:i(()=>[o(t($),null,{default:i(()=>[...c[2]||(c[2]=[_("En cours",-1)])]),_:1})]),_:1}),o(t(U),{value:"RÃ©solu",class:"modern-segment-button"},{default:i(()=>[o(t($),null,{default:i(()=>[...c[3]||(c[3]=[_("RÃ©solu",-1)])]),_:1})]),_:1})]),_:1},8,["value"])]),a.isAuthenticated?(f(),K("div",je,[b("label",Pe,[o(t(Se),{checked:a.modelOnlyMine,onIonChange:l,class:"modern-checkbox"},null,8,["checked"]),c[5]||(c[5]=b("span",{class:"checkbox-label"},"Mes signalements uniquement",-1))])])):V("",!0)])]),_:1})):V("",!0)}}),Ge=I(Re,[["__scopeId","data-v-131a57c1"]]),Ke={key:0,class:"map-loader"},Je=x({__name:"MapLoader",props:{isLoading:{type:Boolean},message:{}},setup(a){return(e,n)=>a.isLoading?(f(),K("div",Ke,[o(t(ke),{name:"crescent"}),b("p",null,Me(a.message),1)])):V("",!0)}}),Qe=I(Je,[["__scopeId","data-v-9e9dd113"]]),We=x({__name:"AddSignalementButton",props:{show:{type:Boolean}},emits:["click"],setup(a){return(e,n)=>a.show?(f(),M(t(xe),{key:0,vertical:"bottom",horizontal:"end",slot:"fixed"},{default:i(()=>[o(t(Le),{onClick:n[0]||(n[0]=s=>e.$emit("click"))},{default:i(()=>[o(t(C),{icon:t(Oe)},null,8,["icon"])]),_:1})]),_:1})):V("",!0)}}),Xe={class:"user-location-button"},Ye=x({__name:"UserLocationButton",props:{isTrackingLocation:{type:Boolean}},emits:["toggle-tracking"],setup(a,{emit:e}){const n=e;function s(){n("toggle-tracking")}return(l,u)=>(f(),K("div",Xe,[o(t(z),{color:a.isTrackingLocation?"primary":"medium",fill:"solid",shape:"round",size:"default",onClick:s,class:"location-btn"},{default:i(()=>[o(t(C),{icon:a.isTrackingLocation?t(De):t(ze),slot:"icon-only"},null,8,["icon"])]),_:1},8,["color"])]))}}),Ze=I(Ye,[["__scopeId","data-v-79cf7e23"]]),h={async showAlert(a,e){await(await D.create({header:a,message:e,buttons:["OK"]})).present()},async showSuccess(a){await this.showAlert("SuccÃ¨s !",a)},async showError(a){await this.showAlert("Erreur",a)},async showConfirm(a,e,n="Confirmer",s="Annuler"){return new Promise(async l=>{await(await D.create({header:a,message:e,buttons:[{text:s,role:"cancel",handler:()=>l(!1)},{text:n,handler:()=>l(!0)}]})).present()})},async showSignalementForm(){return new Promise(async a=>{await(await D.create({header:"DÃ©crire le problÃ¨me",inputs:[{name:"description",type:"textarea",placeholder:"DÃ©crivez le problÃ¨me routier (nid-de-poule, route dÃ©gradÃ©e, etc.)"},{name:"localisation",type:"text",placeholder:"Adresse ou nom du lieu (optionnel)"}],buttons:[{text:"Annuler",role:"cancel",handler:()=>a(null)},{text:"Envoyer",handler:n=>a(n)}]})).present()})},async showSignalementModeInfo(){await this.showAlert("Mode signalement activÃ©","Cliquez sur la carte pour placer un marqueur Ã  l'emplacement du problÃ¨me.")},async showLocationChoice(){return new Promise(async a=>{await(await D.create({header:"ðŸ“ Localisation du signalement",message:"OÃ¹ se trouve le problÃ¨me ?",buttons:[{text:"Annuler",role:"cancel",handler:()=>a(null)},{text:"Ã€ ma position",cssClass:"primary-button",handler:()=>a("current")},{text:"Choisir sur la carte",handler:()=>a("map")}]})).present()})}},et=x({__name:"MapPage",setup(a){const{isAuthenticated:e,logout:n,goToLogin:s}=ee(),{filteredSignalements:l,selectedStatus:u,showOnlyMySignalements:c,subscribeToSignalements:S,unsubscribeFromSignalements:q,applyFilters:A,createSignalement:L}=Be(),{isMapReady:N,isTrackingLocation:T,userLocation:E,initMap:r,destroyMap:k,displaySignalements:w,addTempMarker:v,removeTempMarker:y,startTrackingLocation:B,stopTrackingLocation:te}=Te(),H=p(!1),j=p(!1);_e(()=>{setTimeout(()=>{r(ie),S()},100)}),Y(()=>{q(),k()}),Ce(l,g=>{w(g)});function ne(){A()}function ae(){T.value?te():B(!0)}async function oe(){await n()}async function se(){const g=await h.showLocationChoice();g&&(g==="current"?await le():(j.value=!0,await h.showSignalementModeInfo()))}async function le(){if(!E.value){await h.showError("Position non disponible. Veuillez activer la gÃ©olocalisation.");return}const{lat:g,lng:d}=E.value;v(g,d);const m=await h.showSignalementForm();if(m)try{await L(g,d,m.description,m.localisation||""),await h.showSuccess("Signalement crÃ©Ã© avec succÃ¨s !")}catch(re){await h.showError("Impossible de crÃ©er le signalement. VÃ©rifiez votre connexion.")}y()}async function ie(g,d){if(!j.value)return;v(g,d);const m=await h.showSignalementForm();if(m)try{await L(g,d,m.description,m.localisation||""),await h.showSuccess("Signalement crÃ©Ã© avec succÃ¨s !")}catch(re){await h.showError("Impossible de crÃ©er le signalement. VÃ©rifiez votre connexion.")}y(),j.value=!1}return(g,d)=>(f(),M(t(Ae),null,{default:i(()=>[o(t(qe),{isAuthenticated:t(e),onToggleFilters:d[2]||(d[2]=m=>H.value=!H.value),onLogout:oe,onGoToLogin:t(s)},{filters:i(()=>[o(t(Ge),{show:H.value,modelStatus:t(u),modelOnlyMine:t(c),isAuthenticated:t(e),"onUpdate:modelStatus":d[0]||(d[0]=m=>u.value=m),"onUpdate:modelOnlyMine":d[1]||(d[1]=m=>c.value=m),onFiltersChanged:ne},null,8,["show","modelStatus","modelOnlyMine","isAuthenticated"])]),_:1},8,["isAuthenticated","onGoToLogin"]),o(t(Ie),{fullscreen:!0},{default:i(()=>[o(t(Qe),{isLoading:!t(N),message:"Chargement de la carte..."},null,8,["isLoading"]),d[3]||(d[3]=b("div",{id:"map",class:"map-container"},null,-1)),o(t(Ze),{isTrackingLocation:t(T),onToggleTracking:ae},null,8,["isTrackingLocation"]),o(t(We),{show:t(e),onClick:se},null,8,["show"])]),_:1})]),_:1}))}}),ot=I(et,[["__scopeId","data-v-d7a9ba49"]]);export{ot as default};
